/* Library libcerf:
 *   Compute complex error functions, based on a new implementation of
 *   Faddeeva's w_of_z. Also provide Dawson and Voigt functions.
 *
 * File im_w_of_x.c:
 *   Compute scaled Dawson integral im_w_of_x(x) = 2*dawson(x)/sqrt(pi),
 *   equivalent to the imaginary part of the Faddeeva function w(x) for real x.
 *
 * Copyright:
 *   (C) 2012 Massachusetts Institute of Technology
 *   (C) 2013, 2024 Forschungszentrum Jülich GmbH
 *
 * Licence:
 *   Permission is hereby granted, free of charge, to any person obtaining
 *   a copy of this software and associated documentation files (the
 *   "Software"), to deal in the Software without restriction, including
 *   without limitation the rights to use, copy, modify, merge, publish,
 *   distribute, sublicense, and/or sell copies of the Software, and to
 *   permit persons to whom the Software is furnished to do so, subject to
 *   the following conditions:
 *
 *   The above copyright notice and this permission notice shall be
 *   included in all copies or substantial portions of the Software.
 *
 *   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 *   EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 *   MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 *   NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 *   LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 *   OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 *   WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * Authors:
 *   Steven G. Johnson, Massachusetts Institute of Technology, 2012
 *   Joachim Wuttke, Forschungszentrum Jülich, 2013, 2024
 *
 * Website:
 *   http://apps.jcns.fz-juelich.de/libcerf
 *
 * Revision history:
 *   The numerics in this file has been almost entirely reworked by Joachim Wuttke
 *   in September 2024. For large |x|, continuous fractions were replaced with
 *   asymptotic expansions. The small |x| range where Taylor series is used was
 *   expanded. In the middle range, the subdivision in subranges was redone. To avoid
 *   a division, the transformation x -> 1/(1+x) was dropped. Chebyshev coefficients were
 *   recomputed using a Python/mpmath script included in the source repository.
 *   Thereby, an accuracy better than 4 epsilon was achieved.
 *
 *   See also ../CHANGELOG
 *
 * Manual page:
 *   man 3 im_w_of_x
 */

#include "cerf.h"
#include <math.h>
#include "defs.h" // defines _cerf_cmplx, NaN, C, cexp, ...

// for analysing the algorithm:
IMPORT extern int faddeeva_algorithm;
IMPORT extern int faddeeva_nofterms;

static double cheb(const double x, const double*const C, const int N)
{
    // Evaluates Chebyshev interpolant using Clenshaw's algorithm.
    double u2 = 0;
    double u1 = C[N];
    for (int n = N-1; n > 0; --n) {
	double u = 2*x*u1 - u2 + C[n];
	u2 = u1;
	u1 = u;
    }
    return x*u1 - u2 + C[0];
}

// The follwowing four functions compute Im w(x) by Chebyshev interpolation.
// Each function addresses a certain range aCheb<n> to bCheb<n>, which is further
// divided in equidistant subranges.
// Each subrange has its own Chebyshev interpolant.
// Maximum degree is 7. A few interpolants have lower degree.
// Coefficients are computed, and corresponding code sections are written,
// by script devtool/chebcoef_imwofx.py.

//--- The following code is generated by devtool/pro_imwofx_chebcoeffs.py
// clang-format off
static const double aCheb1 = 0.94;
static const double bCheb1 = 1.8;
static double chebInterpolant1(double x)
{
    static const int nSubranges = 17;
    static const double invSubwidth = nSubranges / (bCheb1 - aCheb1);
    static const double ChebCoeffs[17 * 9] = {
        +6.0931551701696796e-01, -1.2170664564525617e-03, -1.8004013320617490e-04, +1.5951186438208075e-06, +4.6610674089966367e-09, -1.2481437892257239e-10, +2.5942669119075230e-13, +4.7988692374041261e-15, -5.0041269611614867e-17, // x in (0.94..0.990588)
        +6.0550244892637528e-01, -2.5797413167920852e-03, -1.6053240785809472e-04, +1.6501077317206295e-06, +2.2374452829322734e-09, -1.1706928332363999e-10, +3.8209094625990496e-13, +3.9472465177581593e-15, -5.5915098092882699e-17, // x in (0.990588..1.04118)
        +5.9912172555793741e-01, -3.7843613525558512e-03, -1.4059187385666614e-04, +1.6677097541308869e-06, -3.8160227656446076e-12, -1.0667562389244078e-10, +4.7982057430996890e-13, +3.0258327902771292e-15, -5.8779243224325209e-17, // x in (1.04118..1.09176)
        +5.9049153585385572e-01, -4.8292052598497221e-03, -1.2064802820185600e-04, +1.6512331724800468e-06, -2.0158599261681462e-09, -9.4249894283724864e-11, +5.5132618740604023e-13, +2.0816784300984820e-15, -5.8795993478462621e-17, // x in (1.09176..1.14235)
        +5.7993020948285234e-01, -5.7158171054350190e-03, -1.0108657924745549e-04, +1.6046362749686541e-06, -3.7643642544768745e-09, -8.0424083207828383e-11, +5.9658888176349432e-13, +1.1581243095198917e-15, -5.6262057744316336e-17, // x in (1.14235..1.19294)
        +5.6775005868597617e-01, -6.4486282482147826e-03, -8.2242857049950137e-05, +1.5323257640099168e-06, -5.2275558408675443e-09, -6.5816658597642395e-11, +6.1672850838978840e-13, +2.9289452704554841e-16, -5.1577402133684634e-17, // x in (1.19294..1.24353)
        +5.5425202136848295e-01, -7.0345361723820783e-03, -6.4397623522495368e-05, +1.4389595637588071e-06, -6.3956804465289604e-09, -5.1007295992309815e-11, +6.1382580366062926e-13, -4.8328374510674171e-16, -4.5210965676557296e-17, // x in (1.24353..1.29412)
        +5.3972117267698483e-01, -7.4824590860122255e-03, -4.7775182116310790e-05, +1.3292619083893529e-06, -7.2700127463666380e-09, -3.6516276972527610e-11, +5.9071363794823717e-13, -1.1475046916749439e-15, -3.7665894298570962e-17, // x in (1.29412..1.34471)
        +5.2442313568490884e-01, -7.8028839740735484e-03, -3.2543598704844663e-05, +1.2078572879148867e-06, -7.8615059309902398e-09, -2.2789112354121672e-11, +5.5075286619825504e-13, -1.6849643499499898e-15, -2.9446673767499472e-17, // x in (1.34471..1.39529)
        +5.0860138816828449e-01, -8.0074240003390335e-03, -1.8816776282764453e-05, +1.0791281667545260e-06, -8.1891879038674599e-09, -1.0186581326998065e-11, +4.9760742942411398e-13, -2.0887439261225627e-15, -2.1030131170881622e-17, // x in (1.39529..1.44588)
        +4.9247543289014090e-01, -8.1083988869152090e-03, -6.6580774450337780e-06, +9.4709966659297585e-07, -8.2784114840215095e-09, +1.0199548019168750e-12, +4.3503164268180666e-13, -2.3591701975163768e-15, -1.2841761830109878e-17, // x in (1.44588..1.49647)
        +4.7623977410350415e-01, -8.1184493275272378e-03, +3.9148395217190411e-06, +8.1535272524611865e-07, -8.1590602742670380e-09, +1.0648388722657747e-11, +3.6668024081664811e-13, -2.5028461195317775e-15, -5.2382779467294187e-18, // x in (1.49647..1.54706)
        +4.6006362358245489e-01, -8.0501937717159903e-03, +1.2924313806837842e-05, +6.8696569747126046e-07, -7.8638010471294686e-09, +1.8601498614816855e-11, +2.9594898732776037e-13, -2.5314546021683172e-15, +1.5032821644163782e-18, // x in (1.54706..1.59765)
        +4.4409124554131330e-01, -7.9159331994367449e-03, +2.0426438699354290e-05, +5.6448302250006082e-07, -7.4264589525430978e-09, +2.4859172901740656e-11, +2.2585073210736946e-13, -2.4604396762404892e-15, +7.1900552980784412e-18, // x in (1.59765..1.64824)
        +4.2844284117052889e-01, -7.7274069174886658e-03, +2.6504592581547328e-05, +4.4990849525499628e-07, -6.8805749550715840e-09, +2.9468108906992675e-11, +1.5892895769188222e-13, -2.3076629850585914e-15, +1.1712063913939414e-17, // x in (1.64824..1.69882)
        +4.1321586983819325e-01, -7.4956000549276170e-03, +3.1263020533840377e-05, +3.4471987033771901e-07, -6.2581870218990167e-09, +3.2529883343927695e-11, +9.7208271803750597e-14, -2.0921212253572415e-15, +1.5036057777964986e-17, // x in (1.69882..1.74941)
        +3.9848670473034892e-01, -7.2306013916240280e-03, +3.4820700143742918e-05, +2.4990100571585531e-07, -5.5888589394659229e-09, +3.4188252563180691e-11, +4.2179130604062938e-14, -1.8327936030335876e-15, +1.7195615540710639e-17, // x in (1.74941..1.8)
    };
    const int s = (int)((x-aCheb1)*invSubwidth); // index of subrange
    faddeeva_nofterms = s;
    const double center = ((nSubranges-0.5)-s)*(aCheb1/nSubranges) + (s+0.5) * (bCheb1/nSubranges);
    const double t = 2 * invSubwidth * (x-center); // coord in subrange, between -1 and +1
    const double *const c = ChebCoeffs + s * 9;
    return cheb(t, c, 8);
}
// clang-format on
//--- End of autogenerated code

//--- The following code is generated by devtool/pro_imwofx_chebcoeffs.py
// clang-format off
static const double aCheb2 = 1.8;
static const double bCheb2 = 3.4;
static double chebInterpolant2(double x)
{
    static const int nSubranges = 29;
    static const double invSubwidth = nSubranges / (bCheb2 - aCheb2);
    static const double ChebCoeffs[29 * 9] = {
        +3.8369124278140293e-01, -7.5556683611708274e-03, +4.4474957052842109e-05, +2.1077436439506255e-07, -6.8866097449116353e-09, +5.3399273967227820e-11, -1.1996333393920001e-14, -2.8160777473305048e-15, +3.6635528208198220e-17, // x in (1.8..1.85517)
        +3.6894244627606698e-01, -7.1915437560861242e-03, +4.6378257365965828e-05, +1.0909123649991453e-07, -5.8275464066307893e-09, +5.2231729604414779e-11, -8.2593011713821665e-14, -2.2262201927145900e-15, +3.6762787264242363e-17, // x in (1.85517..1.91034)
        +3.5493346323510616e-01, -6.8167878183135466e-03, +4.7161976773637313e-05, +2.4079864997278683e-08, -4.8074419713636349e-09, +4.9567392062826083e-11, -1.3679006645667379e-13, -1.6495495913133187e-15, +3.5057514437510319e-17, // x in (1.91034..1.96552)
        +3.4167722431048875e-01, -6.4395696846562258e-03, +4.7021517205332533e-05, -4.5101376992524999e-08, -3.8523425842362474e-09, +4.5792307706969496e-11, -1.7533454000859037e-13, -1.1118784527290727e-15, +3.1960651216013832e-17, // x in (1.96552..2.02069)
        +3.2917184849545472e-01, -6.0665421798232061e-03, +4.6139931636348836e-05, -9.9650292733533758e-08, -2.9808071587958545e-09, +4.1266721714664446e-11, -1.9959697744210856e-13, -6.3193442774616600e-16, +2.7911643358061824e-17, // x in (2.02069..2.07586)
        +3.1740356483093979e-01, -5.7029557121683989e-03, +4.4684349266752131e-05, -1.4100594018528439e-07, -2.2045570460874617e-09, +3.6312477884968242e-11, -2.1137563901905445e-13, -2.2162054970662348e-16, +2.3320114212592343e-17, // x in (2.07586..2.13103)
        +3.0634938195265138e-01, -5.3527954459763692e-03, +4.2803709894345507e-05, -1.7074586909839986e-07, -1.5293315589492731e-09, +3.1204982143626659e-11, -2.1271377818572042e-13, +1.1333220287208279e-16, +1.8545216159833700e-17, // x in (2.13103..2.18621)
        +2.9597946890218779e-01, -5.0189319095484287e-03, +4.0627644761396362e-05, -1.9049810090747034e-07, -9.5586203083015763e-10, +2.6169298346238854e-11, -2.0573923472402751e-13, +3.7244405070689239e-16, +1.3882691112275803e-17, // x in (2.18621..2.24138)
        +2.8625922892342087e-01, -4.7032766011142688e-03, +3.8266318208917430e-05, -2.0186911821067729e-07, -4.8088765608069470e-10, +2.1379764406530796e-11, -1.9253216316373520e-13, +5.5941653134109170e-16, +9.5590417698768348e-18, // x in (2.24138..2.29655)
        +2.7715106332193762e-01, -4.4069356808270127e-03, +3.5811036213679414e-05, -2.0638800696887581e-07, -9.8149731022652352e-11, +1.6962415856123556e-11, -1.7502354812807187e-13, +6.8101944528205630e-16, +5.7317658731621537e-18, // x in (2.29655..2.35172)
        +2.6861583474342815e-01, -4.1303563792301785e-03, +3.3335431771043783e-05, -2.0546599701471586e-07, +2.0068442029068822e-10, +1.2999473829638580e-11, -1.5492445219209588e-13, +7.4602136166291947e-16, +2.4943399221524225e-18, // x in (2.35172..2.4069)
        +2.6061404848311320e-01, -3.8734622245428884e-03, +3.0897050328359006e-05, -2.0036998503291905e-07, +4.2520188879662254e-10, +9.5351824765342249e-12, -1.3368381771602237e-13, +7.6422841908732213e-16, -1.1545788657234403e-19, // x in (2.4069..2.46207)
        +2.5310677687888744e-01, -3.6357745293144525e-03, +2.8539178271711221e-05, -1.9220819031059920e-07, +5.8554940132882959e-10, +6.5823522910424796e-12, -1.1247114637368118e-13, +7.4567378762886551e-16, -2.1052511339164517e-18, // x in (2.46207..2.51724)
        +2.4605635577735818e-01, -3.4165187395852037e-03, +2.6292781216374466e-05, -1.8192586480920651e-07, +6.9187182510384485e-10, +4.1290659052806935e-12, -9.2179490095653583e-14, +6.9997939979036672e-16, -3.5170099473479438e-18, // x in (2.51724..2.57241)
        +2.3942688386978109e-01, -3.2147152143952007e-03, +2.4178444270281931e-05, -1.7030892385432792e-07, +7.5388272603946713e-10, +2.1451176384792658e-12, -7.3443838794607174e-14, +6.3589380960930783e-16, -4.4162325676351829e-18, // x in (2.57241..2.62759)
        +2.3318455577700994e-01, -3.0292547646545045e-03, +2.2208231664067298e-05, -1.5799344559422369e-07, +7.8055835645322384e-10, +5.8787565631560418e-13, -5.6670086616481251e-14, +5.6099610932846101e-16, -4.8821066910168668e-18, // x in (2.62759..2.68276)
        +2.2729785851972334e-01, -2.8589598455301189e-03, +2.0387406750146382e-05, -1.4547916898811087e-07, +7.7994135186575221e-10, -5.9263337655961431e-13, -4.2070187599569170e-14, +4.8154600110755049e-16, -4.9991382925100988e-18, // x in (2.68276..2.73793)
        +2.2173765881816024e-01, -2.7026326827133684e-03, +1.8715974384940300e-05, -1.3314536610882668e-07, +7.5903741845827770e-10, -1.4495193867506312e-12, -2.9699760060125534e-14, +4.0245423366820798e-16, -4.8505010741673611e-18, // x in (2.73793..2.7931)
        +2.1647720585940727e-01, -2.5590918435287012e-03, +1.7190025541591550e-05, -1.2126774377215017e-07, +7.2378708532815111e-10, -2.0357252117626266e-12, -1.9495162279011840e-14, +3.2734520249697557e-16, -4.5131616702804053e-18, // x in (2.7931..2.84828)
        +2.1149207103479914e-01, -2.4271988653913061e-03, +1.5802878417154427e-05, -1.1003531614335434e-07, +6.7909481638340283e-10, -2.4015836766522537e-12, -1.1307851752964107e-14, +2.5868391537079621e-16, -4.0546827843358727e-18, // x in (2.84828..2.90345)
        +2.0676004291596045e-01, -2.3058765539453342e-03, +1.4546021333978025e-05, -9.9566464186465881e-08, +6.2889904932273323e-10, -2.5931515583638859e-12, -4.9345879509075048e-15, +1.9794199700766888e-16, -3.5315006772182616e-18, // x in (2.90345..2.95862)
        +2.0226099258248342e-01, -2.1941204875094811e-03, +1.3409870627883926e-05, -8.9923645679683127e-08, +5.7626869675480648e-10, -2.6512101148761410e-12, -1.4269669141608052e-16, +1.4578120940031637e-16, -2.9884120572911412e-18, // x in (2.95862..3.01379)
        +1.9797672146423942e-01, -2.0910051369357023e-03, +1.2384361838001373e-05, -8.1126432484388139e-08, +5.2351399234709446e-10, -2.6108098286904980e-12, +3.3098448020756158e-15, +1.0223743403777381e-16, -2.4589822163396472e-18, // x in (3.01379..3.06897)
        +1.9389080119971255e-01, -1.9956858510575513e-03, +1.1459395310979223e-05, -7.3162725891645696e-08, +4.7230203374779753e-10, -2.5012364402937192e-12, +5.6593301161185247e-15, +6.6892651624508724e-17, -1.9665930813668165e-18, // x in (3.06897..3.12414)
        +1.8998841268422939e-01, -1.9073977842819086e-03, +1.0625158276275310e-05, -6.5998135908281602e-08, +4.2376976553524889e-10, -2.3462831664191638e-12, +7.1257933068948072e-15, +3.9026753351533237e-17, -1.5258779793077623e-18, // x in (3.12414..3.17931)
        +1.8625618950456302e-01, -1.8254526675487706e-03, +9.8723449960653576e-06, -5.9583608705068889e-08, +3.7862932096681489e-10, -2.1647273372448021e-12, +7.9063913471574194e-15, +1.7744752057811363e-17, -1.1443310217874494e-18, // x in (3.17931..3.23448)
        +1.8268206932268988e-01, -1.7492341563310760e-03, +9.1922951592306826e-06, -5.3861452329809159e-08, +3.3726251614092817e-10, -1.9709260450752220e-12, +8.1719846704570493e-15, +2.0779834545954250e-18, -8.2392590176906651e-19, // x in (3.23448..3.28966)
        +1.7925515545925233e-01, -1.6781923359442338e-03, +8.5770686331631898e-06, -4.8769949365364836e-08, +2.9980282506375713e-10, -1.7754627463674050e-12, +8.0661951039659502e-15, -8.9398476573090133e-18, -5.6262584456137516e-19, // x in (3.28966..3.34483)
        +1.7596558990422406e-01, -1.6118378289389941e-03, +8.0194723044056893e-06, -4.4246761995608865e-08, +2.6620435526257270e-10, -1.5857935752583664e-12, +7.7062675983301607e-15, -1.6219379849915360e-17, -3.5570939020319108e-19, // x in (3.34483..3.4)
    };
    const int s = (int)((x-aCheb2)*invSubwidth); // index of subrange
    faddeeva_nofterms = s;
    const double center = ((nSubranges-0.5)-s)*(aCheb2/nSubranges) + (s+0.5) * (bCheb2/nSubranges);
    const double t = 2 * invSubwidth * (x-center); // coord in subrange, between -1 and +1
    const double *const c = ChebCoeffs + s * 9;
    return cheb(t, c, 8);
}
// clang-format on
//--- End of autogenerated code

//--- The following code is generated by devtool/pro_imwofx_chebcoeffs.py
// clang-format off
static const double aCheb3 = 3.4;
static const double bCheb3 = 5.84;
static double chebInterpolant3(double x)
{
    static const int nSubranges = 25;
    static const double invSubwidth = nSubranges / (bCheb3 - aCheb3);
    static const double ChebCoeffs[25 * 9] = {
        +1.7163702783630716e-01, -2.7015360872978829e-03, +2.2946480137367392e-05, -2.1492681328979706e-07, +2.2114367776247874e-09, -2.3246892347864150e-11, +2.1318104807229159e-13, -1.1710455193230218e-15, -1.4163396428186293e-17, // x in (3.4..3.4976)
        +1.6640976268928068e-01, -2.5277128084792559e-03, +2.0565182504840986e-05, -1.8299683924228163e-07, +1.7949102063286059e-09, -1.8541203365683108e-11, +1.7856117828392303e-13, -1.2605704865215307e-15, +1.3991150147462236e-18, // x in (3.4976..3.5952)
        +1.6151223161364953e-01, -2.3715137102034134e-03, +1.8530016305936040e-05, -1.5702392295580963e-07, +1.4641136386566689e-09, -1.4672410053061066e-11, +1.4426605383963863e-13, -1.1689193989579463e-15, +9.0271148965585206e-18, // x in (3.5952..3.6928)
        +1.5691174455956056e-01, -2.2304336229639842e-03, +1.6777180080355947e-05, -1.3576837890999584e-07, +1.2027300448616724e-09, -1.1584733705729918e-11, +1.1382674151426504e-13, -9.9832832816589711e-16, +1.1688499546121560e-17, // x in (3.6928..3.7904)
        +1.5258015545168171e-01, -2.1024226120203407e-03, +1.5256231451872729e-05, -1.1823894609980669e-07, +9.9619981709986482e-10, -9.1669846444727582e-12, +8.8519160824251172e-14, -8.0971774072483704e-16, +1.1574118989197652e-17, // x in (3.7904..3.888)
        +1.4849304953425413e-01, -1.9857904841140378e-03, +1.3927302805912252e-05, -1.0365837622199104e-07, +8.3237419313022478e-10, -7.2942071307790984e-12, +6.8347693425171099e-14, -6.3493024285931125e-16, +1.0146963277579690e-17, // x in (3.888..3.9856)
        +1.4462910082441152e-01, -1.8791317948026068e-03, +1.2758768993919034e-05, -9.1424061770952721e-08, +7.0154480678439788e-10, -5.8496817117830076e-12, +5.2706415831307925e-14, -4.8725801571081645e-16, +8.2904570493728628e-18, // x in (3.9856..4.0832)
        +1.4096956237546360e-01, -1.7812676445880416e-03, +1.1725378347212647e-05, -8.1070944614710002e-08, +5.9616947370032106e-10, -4.7343097178871475e-12, +4.0781400339909434e-14, -3.6935748232680831e-16, +6.4772623241072842e-18, // x in (4.0832..4.1808)
        +1.3749785934538708e-01, -1.6912007323404970e-03, +1.0806797776116309e-05, -7.2239858841363244e-08, +5.1049044293216467e-10, -3.8687025886155384e-12, +3.1768144989061250e-14, -2.7859644577189776e-16, +4.9171322233814833e-18, // x in (4.1808..4.2784)
        +1.3419926144786209e-01, -1.6080806337887264e-03, +9.9865005186148277e-06, -6.4652078634908442e-08, +4.4015223368697956e-10, -3.1915979112440723e-12, +2.4969805178892156e-14, -2.1031821652725077e-16, +3.6684680856279751e-18, // x in (4.2784..4.376)
        +1.3106061684414808e-01, -1.5311768571681524e-03, +9.2509240105285675e-06, -5.8089626899740697e-08, +3.8186829344684484e-10, -2.6568301641387710e-12, +1.9826216475620038e-14, -1.5961799042335853e-16, +2.7134853147016667e-18, // x in (4.376..4.4736)
        +1.2807013387403987e-01, -1.4598577766148373e-03, +8.5888341325465577e-06, -5.2380409481532068e-08, +3.3315181814299842e-10, -2.2300804874478856e-12, +1.5907655078488266e-14, -1.2216375853030580e-16, +2.0038569908712122e-18, // x in (4.4736..4.5712)
        +1.2521720035043271e-01, -1.3935740063884623e-03, +7.9908441060620353e-06, -4.7387150832980427e-08, +2.9210859850787232e-10, -1.8859802003246915e-12, +1.2894117735856384e-14, -9.4465308632836817e-17, +1.4854332705691725e-18, // x in (4.5712..4.6688)
        +1.2249223264006433e-01, -1.3318451449690193e-03, +7.4490480931672069e-06, -4.2999209566777754e-08, +2.5728241429085002e-10, -1.6057642764696110e-12, +1.0551489035206561e-14, -7.3862793232261007e-17, +1.1096763469638591e-18, // x in (4.6688..4.7664)
        +1.1988654860841398e-01, -1.2742490961861856e-03, +6.9567396169704257e-06, -3.9126522907508463e-08, +2.2754175431905779e-10, -1.3754763880214379e-12, +8.7099372486733823e-15, -5.8399026329313111e-17, +8.3752560475856669e-19, // x in (4.7664..4.864)
        +1.1739225987975314e-01, -1.2204133805802475e-03, +6.5081928705950715e-06, -3.5695103287802101e-08, +2.0199756725924197e-10, -1.1846446846502711e-12, +7.2464139585697773e-15, -4.6664076193219853e-17, +6.3947214494123684e-19, // x in (4.864..4.9616)
        +1.1500217988152209e-01, -1.1700080006275722e-03, +6.0984909751833091e-06, -3.2643660407827672e-08, +1.7994364583552695e-10, -1.0253261620095187e-12, +6.0713755668997274e-15, -3.7653188438999185e-17, +4.9408338760356324e-19, // x in (4.9616..5.0592)
        +1.1270974490212546e-01, -1.1227395326298293e-03, +5.7233896282711710e-06, -2.9921040260593478e-08, +1.6081324406196766e-10, -8.9142492148088597e-13, +5.1191101126248862e-15, -3.0652294091958793e-17, +3.8615965272404416e-19, // x in (5.0592..5.1568)
        +1.1050894596375883e-01, -1.0783461973300759e-03, +5.3792077310378051e-06, -2.7484260786620374e-08, +1.4414725027124228e-10, -7.7820741834650257e-13, +4.3408633598081816e-15, -2.5152102140833999e-17, +3.0505539211624371e-19, // x in (5.1568..5.2544)
        +1.0839426974800660e-01, -1.0365937191967743e-03, +5.0627388253173116e-06, -2.5296987398389222e-08, +1.2957058520452748e-10, -6.8195670780940769e-13, +3.7000184964205941e-15, -2.0786405581424052e-17, +2.4334212367775466e-19, // x in (5.2544..5.352)
        +1.0636064714808909e-01, -9.9727182696915623e-04, +4.7711787678751323e-06, -2.3328336554467364e-08, +1.1677448643129496e-10, -5.9972390224076596e-13, +3.1687305151366457e-15, -1.7288940175154626e-17, +1.9582001081773499e-19, // x in (5.352..5.4496)
        +1.0440340828370785e-01, -9.6019127984738300e-04, +4.5020662119697943e-06, -2.1551927024476364e-08, +1.0550304508719213e-10, -5.2914755281365215e-13, +2.7255701346697617e-15, -1.4463643889262040e-17, +1.5881956373476748e-19, // x in (5.4496..5.5472)
        +1.0251824302099972e-01, -9.2518132769704243e-04, +4.2532332912399119e-06, -1.9945120477825708e-08, +9.5542850911395940e-11, -4.6832073757225359e-13, +2.3538616389702597e-15, -1.2164252057742855e-17, +1.2972157831595938e-19, // x in (5.5472..5.6448)
        +1.0070116620454700e-01, -8.9208753195850704e-04, +4.0227645036462526e-06, -1.8488408473751474e-08, +8.6714938730340043e-11, -4.1569197490980672e-13, +2.0404971306490271e-15, -1.0280261800927401e-17, +1.0663182594193139e-19, // x in (5.6448..5.7424)
        +9.8948486940482056e-02, -8.6076988810964848e-04, +3.8089622391254136e-06, -1.7164913876253040e-08, +7.8868461115999419e-11, -3.6999041315052117e-13, +1.7750795934792597e-15, -8.7272003286874358e-18, +8.8161613395341844e-20, // x in (5.7424..5.84)
    };
    const int s = (int)((x-aCheb3)*invSubwidth); // index of subrange
    faddeeva_nofterms = s;
    const double center = ((nSubranges-0.5)-s)*(aCheb3/nSubranges) + (s+0.5) * (bCheb3/nSubranges);
    const double t = 2 * invSubwidth * (x-center); // coord in subrange, between -1 and +1
    const double *const c = ChebCoeffs + s * 9;
    return cheb(t, c, 8);
}
// clang-format on
//--- End of autogenerated code

//--- The following code is generated by devtool/pro_imwofx_chebcoeffs.py
// clang-format off
static const double aCheb4 = 5.84;
static const double bCheb4 = 10.9;
static double chebInterpolant4(double x)
{
    static const int nSubranges = 28;
    static const double invSubwidth = nSubranges / (bCheb4 - aCheb4);
    static const double ChebCoeffs[28 * 9] = {
        +9.6562762453239206e-02, -1.5165429756270267e-03, +1.2104392062286880e-05, -9.8287579232452067e-08, +8.1277758773222001e-10, -6.8530307592215661e-12, +5.8998831999322283e-14, -5.1954800967829138e-16, +9.3769608145804991e-18, // x in (5.84..6.02071)
        +9.3622926197582668e-02, -1.4242145075728403e-03, +1.0998681153306921e-05, -8.6307346406326143e-08, +6.8878032755719151e-10, -5.5959986405821658e-12, +4.6338803259995253e-14, -3.9166147922224415e-16, +6.7673960981264484e-18, // x in (6.02071..6.20143)
        +9.0859333827618863e-02, -1.3401885937185973e-03, +1.0025608600240983e-05, -7.6125315412058096e-08, +5.8715271151195677e-10, -4.6041462468983948e-12, +3.6740744647469088e-14, -2.9872305372528005e-16, +4.9547996932455968e-18, // x in (6.20143..6.38214)
        +8.8256377054777901e-02, -1.2634847350465332e-03, +9.1655805315537806e-06, -6.7422316446610868e-08, +5.0325361567528489e-10, -3.8144253298427568e-12, +2.9382612617525826e-14, -2.3025503147124455e-16, +3.6745475887239393e-18, // x in (6.38214..6.56286)
        +8.5800263133980245e-02, -1.1932650364148486e-03, +8.4024259582122484e-06, -5.9944330130551484e-08, +4.3352709435639944e-10, -3.1804248220932557e-12, +2.3684429168708249e-14, -1.7919367438922907e-16, +2.7568330676914277e-18, // x in (6.56286..6.74357)
        +8.3478754756112605e-02, -1.1288096789369838e-03, +7.7227091057304720e-06, -5.3487500619578444e-08, +3.7522079239836668e-10, -2.6675562928627245e-12, +1.9230837796234695e-14, -1.4068940712828061e-16, +2.0902256153459571e-18, // x in (6.74357..6.92429)
        +8.1280954014281565e-02, -1.0694972442114837e-03, +7.1151974355169207e-06, -4.7886974437925373e-08, +3.2618447691406444e-10, -2.2497527707843105e-12, +1.5720372624474483e-14, -1.1135902139312309e-16, +1.6001780262536348e-18, // x in (6.92429..7.105)
        +7.9197121854277672e-02, -1.0147888088237527e-03, +6.5704462416530227e-06, -4.3008494290576263e-08, +2.8472393155911867e-10, -1.9071682161742907e-12, +1.2931568243737721e-14, -8.8808261928186444e-17, +1.2359644481453878e-18, // x in (7.105..7.28571)
        +7.7218526306330221e-02, -9.6421499508668376e-04, +6.0804714824407834e-06, -3.8742002521668459e-08, +2.4949369957307081e-10, -1.6245509611181398e-12, +1.0699926938672219e-14, -7.1320683428818924e-17, +9.6254097057756255e-19, // x in (7.28571..7.46643)
        +7.5337314222023596e-02, -9.1736535897786464e-04, +5.6384900575205434e-06, -3.4996727751989135e-08, +2.1941746640712623e-10, -1.3900785560961675e-12, +8.9020229903220403e-15, -5.7651171508757627e-17, +7.5536355508372201e-19, // x in (7.46643..7.64714)
        +7.3546402330065666e-02, -8.7387964002888703e-04, +5.2387121089207551e-06, -3.1697377888490995e-08, +1.9362835438256160e-10, -1.1945131560513881e-12, +7.4443796646484415e-15, -4.6886694105270430e-17, +5.9702606218915680e-19, // x in (7.64714..7.82786)
        +7.1839384264678952e-02, -8.3344050511482244e-04, +4.8761737881179623e-06, -2.8781166561498767e-08, +1.7142372704203124e-10, -1.0305825559929044e-12, +6.2555872257956617e-15, -3.8351017260871569e-17, +4.7504214874260601e-19, // x in (7.82786..8.00857)
        +7.0210450873447683e-02, -7.9576749879114474e-04, +4.5466017446065080e-06, -2.6195473096266462e-08, +1.5223067810560325e-10, -8.9252201081003645e-13, +5.2806527279805632e-15, -3.1538635571721348e-17, +3.8035948344774502e-19, // x in (8.00857..8.18929)
        +6.8654321623125500e-02, -7.6061197413623035e-04, +4.2463026618909242e-06, -2.3895988136466031e-08, +1.3557946498951766e-10, -7.7573190179386632e-13, +4.4769062952346903e-15, -2.6068400274742478e-17, +3.0635065612902288e-19, // x in (8.18929..8.37)
        +6.7166185325733874e-02, -7.2775282503419962e-04, +3.9720727053942270e-06, -2.1845234485513955e-08, +1.2108290293275669e-10, -6.7651973449669438e-13, +3.8110057016362935e-15, -2.1650605839015985e-17, +2.4811909740479115e-19, // x in (8.37..8.55071)
        +6.5741648728173369e-02, -6.9699287711141801e-04, +3.7211229005400143e-06, -2.0011379975411416e-08, +1.0842026888733609e-10, -5.9190411488901573e-13, +3.2567243696691519e-15, -1.8063385202267854e-17, +2.0201605363826705e-19, // x in (8.55071..8.73143)
        +6.4376691765192312e-02, -6.6815582276391562e-04, +3.4910173317924298e-06, -1.8367279184031538e-08, +9.7324644337972103e-11, -5.1946468277781568e-13, +2.7933038221373436e-15, -1.5135616557620783e-17, +1.6530077309696436e-19, // x in (8.73143..8.91214)
        +6.3067628482019508e-02, -6.4108360782276096e-04, +3.2796217185034761e-06, -1.6889695652725998e-08, +8.7572899846623804e-11, -4.5722640755389060e-13, +2.4042166500870485e-15, -1.2734433157778597e-17, +1.3589901534928937e-19, // x in (8.91214..9.09286)
        +6.1811072800015472e-02, -6.1563419483735577e-04, +3.0850604341118665e-06, -1.5558667340132919e-08, +7.8977723012765716e-11, -4.0356977808922978e-13, +2.0762306686209300e-15, -1.0756019021617239e-17, +1.1222980628726968e-19, // x in (9.09286..9.27357)
        +6.0603908434578052e-02, -5.9167964178631985e-04, +2.9056804301285617e-06, -1.4356986397044993e-08, +7.1381237392488438e-11, -3.5716064933196990e-13, +1.7986958733877010e-15, -9.1187719141036533e-18, +9.3080046982087940e-20, // x in (9.27357..9.45429)
        +5.9443262385628179e-02, -5.6910444606043985e-04, +2.7400208336979752e-06, -1.3269770682607099e-08, +6.4649867762569650e-11, -3.1689511436257163e-13, +1.5629974921332976e-15, -7.7581865327107142e-18, +7.7512999229928124e-20, // x in (9.45429..9.635)
        +5.8326481512259193e-02, -5.4780411241516272e-04, +2.5867872282305647e-06, -1.2284109283147301e-08, +5.8670187477342306e-11, -2.8185593727058112e-13, +1.3621337654203203e-15, -6.6229978733233934e-18, +6.4800968922109772e-20, // x in (9.635..9.81571)
        +5.7251111778440771e-02, -5.2768391072963345e-04, +2.4448298162218498e-06, -1.1388768018494552e-08, +5.3345543990409579e-11, -2.5127793644018795e-13, +1.1903880416927225e-15, -5.6722548598249483e-18, +5.4375420190659200e-20, // x in (9.81571..9.99643)
        +5.6214879819083172e-02, -5.0865779519536955e-04, +2.3131248135800533e-06, -1.0573943802545143e-08, +4.8593304211265267e-11, -2.2452033815944342e-13, +1.0430726564702037e-15, -4.8730856802023524e-18, +4.5789746171960838e-20, // x in (9.99643..10.1771)
        +5.5215676527710533e-02, -4.9064746126893134e-04, +2.1907585444012872e-06, -9.8310589685599595e-09, +4.4342596060740336e-11, -2.0104458897193038e-13, +9.1632778789691344e-16, -4.1989809868705101e-18, +3.8691299395713128e-20, // x in (10.1771..10.3579)
        +5.4251542410390347e-02, -4.7358152057620372e-04, +2.0769138008672699e-06, -9.1525884263654924e-09, +4.0532449151554784e-11, -1.8039646582165504e-13, +8.0696266564695263e-16, -3.6284673426555650e-18, +3.2800245157968415e-20, // x in (10.3579..10.5386)
        +5.3320654486961577e-02, -4.5739477712086887e-04, +1.9708581099314551e-06, -8.5319139013796154e-09, +3.7110257977840635e-11, -1.6219158717885788e-13, +7.1232959254191815e-16, -3.1440765705382936e-18, +2.7893476696531760e-20, // x in (10.5386..10.7193)
        +5.2421314551237136e-02, -4.4202759075987310e-04, +1.8719336106591729e-06, -7.9632005993483034e-09, +3.4030506842530311e-11, -1.4610362855424522e-13, +6.3022352412048396e-16, -2.7315408005046788e-18, +2.3792309942629782e-20, // x in (10.7193..10.9)
    };
    const int s = (int)((x-aCheb4)*invSubwidth); // index of subrange
    faddeeva_nofterms = s;
    const double center = ((nSubranges-0.5)-s)*(aCheb4/nSubranges) + (s+0.5) * (bCheb4/nSubranges);
    const double t = 2 * invSubwidth * (x-center); // coord in subrange, between -1 and +1
    const double *const c = ChebCoeffs + s * 9;
    return cheb(t, c, 8);
}
// clang-format on
//--- End of autogenerated code

/******************************************************************************/
/*  Library function im_w_of_z                                                */
/******************************************************************************/

double im_w_of_x(double x)
{
    // Steven G. Johnson, October 2012.
    // Revised for relative accuracy better than 4 epsilon by Joachim Wuttke, Sept 2024.

    // Uses three different methods:
    // - asymptotic expansion for large |x|,
    // - Chebyshev polynomials for medium |x|,
    // - Taylor (Maclaurin) series for small |x|.

    const double ispi = 0.56418958354775628694807945156; // 1 / sqrt(pi)
    const double ax = fabs(x); // very fast

    if (ax < aCheb1) {
        // Use Taylor expansion (2/sqrt(pi)) * (x - 2/3 x^3  + 4/15 x^5  - 8/105 x^7 + ...)

	faddeeva_algorithm = 500;
	const double x2 = x*x;
	if (ax < 0.016) {
	    faddeeva_nofterms = 4;
	    return (((( - 0.085971746064420005629 ) * x2// x^7
		      + 0.30090111122547001970 ) * x2 // x^5
		     - 0.75225277806367504925 ) * x2 // x^3
		    + 1.1283791670955125739 ) * x;
	}
	if (ax < .29) {
	    faddeeva_nofterms = 9;
	    return ((((((((( + 8.38275934019361123956e-6 ) * x2 // x^17
			   - 7.1253454391645686483238e-5 ) * x2 // x^15
			  + 0.00053440090793734269229 ) * x2 // x^13
			 - 0.0034736059015927275001 ) * x2 // x^11
			+ 0.019104832458760001251 ) * x2 // x^9
		       - 0.085971746064420005629 ) * x2 // x^7
		      + 0.30090111122547001970 ) * x2 // x^5
		     - 0.75225277806367504925 ) * x2 // x^3
		    + 1.1283791670955125739 ) * x;
	}
	faddeeva_nofterms = 17;
        return ((((((((((((((((( + 1.16774718055184835728293189e-14 ) * x2 // x^33
			       - 1.92678284791054972871829131e-13 ) * x2 //x^31
			      + 2.98651341426135223029374655e-12 ) * x2 // x^29
			     - 4.33044445067896090883119155e-11 ) * x2 // x^27
			    + 5.8461000084165966602290712e-10 ) * x2 // x^25
			   - 7.30762501052074563638866034e-9 ) * x2 // x^23
			  + 8.40376876209885782941868884e-8 ) * x2 // x^21
			 - 8.82395720020380130481012927e-7 ) * x2 // x^19
			+ 8.38275934019361123956e-6 ) * x2 // x^17
		       - 7.1253454391645686483238e-5 ) * x2 // x^15
		      + 0.00053440090793734269229 ) * x2 // x^13
		     - 0.0034736059015927275001 ) * x2 // x^11
		    + 0.019104832458760001251 ) * x2 // x^9
		   - 0.085971746064420005629 ) * x2 // x^7
		  + 0.30090111122547001970 ) * x2 // x^5
		 - 0.75225277806367504925 ) * x2 // x^3
		+ 1.1283791670955125739 ) * x;
    }

    if (ax < bCheb4) {
        // Intermediate range: Use Chebyshev interpolants.

        if (ax < bCheb2) {
	    if (ax < bCheb1) {
		faddeeva_algorithm = 510;
		return copysign(chebInterpolant1(ax), x);
	    }
	    faddeeva_algorithm = 520;
	    return copysign(chebInterpolant2(ax), x);
        }
	if (ax < bCheb3) {
	    faddeeva_algorithm = 530;
	    return copysign(chebInterpolant3(ax), x);
	}
	faddeeva_algorithm = 540;
	return copysign(chebInterpolant4(ax), x);
    }

    /* else */ {
        // Use asymptotic expansion up to N = 0, 3, 6, or 10

	faddeeva_algorithm = 550;
	// With N=15 or 20 we could extend the range to 7.73 or 6.72,
	// but we expect Chebyshev to be faster.
	if (ax > 125) {
	    if (ax > 6.6e7) { // 1-term expansion, important to avoid overflow
		faddeeva_nofterms = 1; // N = 0
		return ispi / x;
	    }
	    faddeeva_nofterms = 4; // N = 3
	    const double r = 1/x;
	    const double r2 = r*r;
	    return ispi * r * ((((
				     + 1.875) * r2 // coefficient (2N-1)!!/2^N
				 + 0.75) * r2
				+ 0.5) * r2
			       + 1);
	}
	const double r = 1/x;
	const double r2 = r*r;
	if (ax > 22.7) {
	    faddeeva_nofterms = 7; // N=6
	    return ispi * r * (((((((
					+ 162.421875 ) * r2
				    + 29.53125 ) * r2
				   + 6.5625 ) * r2
				  + 1.875 ) * r2
				 + 0.75 ) * r2
				+ 0.5 ) * r2
			       + 1);
	}
	faddeeva_nofterms = 11; // N=10
	return ispi * r * (((((((((((
					+ 639383.8623046875 ) * r2
				    + 67303.564453125 ) * r2
				   + 7918.06640625 ) * r2
				  + 1055.7421875 ) * r2
				 + 162.421875 ) * r2
				+ 29.53125 ) * r2
			       + 6.5625 ) * r2
			      + 1.875 ) * r2
			     + 0.75 ) * r2
			    + 0.5 ) * r2
			   + 1);
    }

} // im_w_of_z
